---

- hosts: all

  tasks:

  - name: Ensure minimum Ansible version
    fail:
      msg: "This playbook requires Ansible 2.0.0 or greater."
    when: "{{ ansible_version.full | version_compare('2.0.0', '<') }}"

  - name: System | Install dependencies
    apt: name={{ item }}
    sudo: yes
    with_items:
      - build-essential
      - git
      - python2.7-dev
      - libffi-dev
      - libjpeg-dev
      - zlib1g-dev
      - python-pip

  - name: MongoDB | Add PPA key
    apt_key:
      id: "EA312927"
      keyserver: "keyserver.ubuntu.com"
    sudo: yes

  - name: MongoDB | Add PPA
    apt_repository:
      repo: "deb https://repo.mongodb.org/apt/ubuntu {{ ansible_distribution_release }}/mongodb-org/3.2 multiverse"
    sudo: yes

  - name: MongoDB | Install package
    apt:
      name: mongodb-org
    sudo: yes

  - name: NodeJS | Add PPA key
    apt_key:
      id: "68576280"
      url: "https://deb.nodesource.com/gpgkey/nodesource.gpg.key"
    sudo: yes

  - name: NodeJS | Add PPA
    apt_repository:
      repo: "deb https://deb.nodesource.com/node_4.x {{ ansible_distribution_release }} main"
    sudo: yes

  - name: NodeJS | Install package
    apt:
      name: nodejs
    sudo: yes

  - name: Girder | Upgrade pip
    pip:
      name: pip
      state: latest
    sudo: yes

  - name: Girder | Install requirements
    pip:
      requirements: "requirements.txt"
      chdir: "/home/vagrant/girder"
    sudo: yes

  - name: Girder | Install Girder
    pip:
      name: ".[plugins]"
      # 'editable' requires Ansible >= 2.0.0
      editable: yes
      chdir: "/home/vagrant/girder"
    sudo: yes

  - name: Girder | Install Grunt globally
    npm:
      name: "{{ item }}"
      global: yes
    with_items:
      - grunt
      - grunt-cli
    sudo: yes

  - name: Girder | Run npm install
    npm:
      path: "/home/vagrant/girder"

  - name: Girder | Run grunt init
    command: grunt init
    args:
      chdir: "/home/vagrant/girder"

  - name: Girder | Run grunt
    command: grunt
    args:
      chdir: "/home/vagrant/girder"
