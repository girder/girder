---

- hosts: all

  handlers:
  - name: restart nginx
    service: name=nginx pattern=/etc/init.d/nginx state=restarted enabled=yes

  - name: restart mongodb
    service: name=mongodb pattern=/etc/init.d/mongodb state=restarted enabled=yes

  tasks:
  - name: add nodejs ppa key
    apt_key: id=68576280 url=https://deb.nodesource.com/gpgkey/nodesource.gpg.key

  - name: add nodejs ppa
    apt_repository: repo="deb https://deb.nodesource.com/node {{ ansible_distribution_release }} main"

  - name: add mongodb ppa key
    apt_key: id=7F0CEB10 url=http://keyserver.ubuntu.com:11371/pks/lookup?op=get&search=0x9ECBEC467F0CEB10

  - name: add mongodb ppa
    apt_repository: repo="deb http://downloads-distro.mongodb.org/repo/ubuntu-upstart dist 10gen"

  - name: install package dependencies
    apt: name={{ item }}
    sudo: yes
    with_items:
      - python-pip
      - python2.7-dev
      - build-essential
      - mongodb-org
      - python-software-properties
      - libffi-dev
      - nodejs
      - screen
      - nginx
      - cmake
      - cmake-curses-gui
      - git

  - name: install girder requirements
    pip: requirements=/vagrant/requirements.txt
    sudo: yes

  - name: install grunt and globally
    npm: name={{ item }} global=yes
    with_items:
      - grunt
      - grunt-cli
    sudo: yes

  - name: run npm install
    npm: path=/vagrant

  - name: run grunt init
    command: grunt init chdir=/vagrant

  - name: run grunt
    command: grunt chdir=/vagrant

  - name: install girder for development
    command: python setup.py develop chdir=/vagrant
    sudo: yes

  - name: disable default nginx site
    file: state=absent path=/etc/nginx/sites-available/default
    sudo: yes
    notify:
      - restart nginx

  - name: add the girder nginx site
    template: src=nginx.j2 dest=/etc/nginx/sites-available/girder
    sudo: yes
    notify:
      - restart nginx

  - name: enable girder nginx site
    file: state=link src=/etc/nginx/sites-available/girder path=/etc/nginx/sites-enabled/girder
    sudo: yes
    notify:
      - restart nginx

  - name: copy helper script
    copy: src=start_girder_in_screen.sh dest=/home/vagrant mode=0744
