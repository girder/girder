---
- name: Converge
  hosts: all
  vars:
    girder_update: no

    nginx_vhosts:
      - listen: "8080 default_server"
        server_name: "girder"
        extra_parameters: |
          location / {
            proxy_set_header Host $proxy_host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://localhost:8888/;
            # Must set the following for SSE notifications to work
            proxy_buffering off;
            proxy_cache off;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            chunked_transfer_encoding off;
            proxy_read_timeout 600s;
            proxy_send_timeout 600s;
          }

  pre_tasks:
    - name: Update package cache
      apt:
        update_cache: yes
      changed_when: false
      become: yes
      become_user: root
      when: ansible_os_family == "Debian"

    - name: Install EPEL
      yum:
        name: "https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm"
        state: present
      become: yes
      become_user: root
      when: ansible_os_family == "RedHat"

    - name: Install virtualenv
      package:
        name: python-virtualenv
      become: yes

  roles:
    - role: python
      python_bin: /usr/local/bin/python3.6
      python_virtualenv: "{{ girder_virtualenv }}"

    - role: Stouts.mongodb
      become: yes
      become_user: root
      when: ansible_os_family == "Debian"

    - role: redhat-mongodb
      become: yes
      become_user: root
      when: ansible_os_family == "RedHat"

    - role: girder
